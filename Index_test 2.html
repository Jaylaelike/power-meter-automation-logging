<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Example</title>
</head>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        padding: 20px;
    }
    h1 {
        color: #007BFF;
    }
    button {
        padding: 10px 15px;
        margin: 5px;
        border: none;
        background-color: #007BFF;
        color: white;
        cursor: pointer;
        border-radius: 5px;
    }
    button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    #messages {
        margin-top: 20px;
        padding: 10px;
        background-color: #fff;
        border: 1px solid #ddd;
        height: 200px;
        overflow-y: scroll;
    }
    #group_Phrae span {
  color: green;
}
    #group_Nan span {
  color: rgb(187, 53, 98);
}
    </style>

<body>
    <h1>Golden Eagle  Omron  meter</h1>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>   
    <div id="Error:" style="color: red;"></div>

    
<div id="status_Phrae">แพร่</div>
<div id="group_Phrae" style="display: block;">
    
    <div>Active Power 1: <span id="phrae-8684" class="green-text"></span></div>
    <div>Active Power 2: <span id="phrae-8685" class="green-text"></span></div>
    <div>Active Power 3: <span id="phrae-8686" class="green-text"></span></div>
    <div>Active Power 4: <span id="phrae-8687" class="green-text"></span></div>
    <div>Active Power 5: <span id="phrae-8688" class="green-text"></span></div>
    <div>MUX#1 TV5 Power Meter totally: <span id="phrae-18069" class="green-text"></span></div>
    <div>MUX#2 MCOT Power Meter totally: <span id="phrae-18070" class="green-text"></span></div>
    <div>MUX#3 PRD Power Meter totally: <span id="phrae-73909" class="green-text"></span></div>
    <div>MUX#4 TPBS Power Meter totally: <span id="phrae-73910" class="green-text"></span></div>
</div>

<div id="status_Nan">น่าน</div>
<div id="group_Nan" style="display: block;">
    <div>Active Power 1: <span id="nan-8684"></span></div>
    <div>Active Power 2: <span id="nan-8685"></span></div>
    <div>Active Power 3: <span id="nan-8686"></span></div>
    <div>Active Power 4: <span id="nan-8687"></span></div>
    <div>Active Power 5: <span id="nan-8688"></span></div>
    <div>MUX#1 TV5 Power Meter totally: <span id="nan-18069"></span></div>
    <div>MUX#2 MCOT Power Meter totally: <span id="nan-18070"></span></div>
    <div>MUX#3 PRD Power Meter totally: <span id="nan-73909"></span></div>
    <div>MUX#4 TPBS Power Meter totally: <span id="nan-73910"></span></div>
</div>

    <script>
        let ws = null;
        const uuids = [
            "361c85bd-d02f-4408-b6a4-b6d17dad82a4", // แพร่
            "951d5993-38eb-4d36-b1d3-1764a151468c", //น่าน
            "b0b82045-b741-43ae-8df4-3a01fc7f858b"
        ];  
 
        const Scene =["",
            "d0cf3a77-e9dd-4419-bec0-b54ecad3e541", // แพร่  หน้า  watt/Hours Meter
            "d0cf3a77-e9dd-4419-bec0-b54ecad3e541", //น่าน   หน้า  watt/Hours Meter

        ]

        const IP =[
            "ws://10.8.1.5/ws", // แพร่
            "ws://10.8.2.5/ws", //น่าน
        ]


        //    let USID = null; // Global variable to store USID
        window.USID = null; // Global variable to store USID

        const messagesDiv = document.getElementById('messages');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');

        function connectWS(UserAgent_IP) {
            // IP[UserAgent_IP]
            let ip = IP[UserAgent_IP] ; // || IP[0]; // ใช้ IP แพร่ เป็นค่าเริ่มต้น
            let Station = UserAgent_IP ; // || 0; // ใช้ 0 สำหรับแพร่ และ 1 สำหรับน่าน

            if (ws && ws.readyState === WebSocket.OPEN) return;
            ws = new WebSocket(ip); // ใช้ IP แพร่ เป็นค่าเริ่มต้น
            ws.onopen = function() {
                // messagesDiv.innerHTML += '<p>Connected to WebSocket server.</p>';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;

                console.log('เชื่อมต่อกับ WebSocket สำเร็จ');

                const DATA = {
                    id: 0,
                    method: "comet.restoreSession",
                    params: [
                        {"$class": "com.wcs.comet.shared.CoreGTLoginContext"},
                         uuids[UserAgent_IP],
                        {"$className": "com.wcs.comet.shared.ClientInfo",
                            userLevel: -1,
                            ConnectionTimeStamp: 0,
                            DataTimeout: 0,
                            IpAddress: null,
                            Protocol: null,
                            ProtocolVersion: 0,
                            SID: -1,
                            USID: null,
                            UserAgent: "GWT Comet Client",
                            UserAgentVersion: 2,
                            UserLevel: -1,
                            UserName: "WebApp Client",
                            Admin: false,
                            Guest: false,
                            Logged: false
                        },
                        30,
                        30]};

                const DATA1 = {
                            id:1,
                            method:"comet.subscribeNotification",
                            params:["", "ScriptEngine", {"displayName": "Admin"}]};

               const DATA2 = {                    
                            id:2,
                            method:"ScriptEngine.setUpdateRate",
                            params:["",3000]}

               const DATA3 = {
                            id:3,
                            method:"ScriptEngine.loadScriptInfo",
                            params:[]}  
                            
            const DATA4 = {
                id: 4,
                method: "ScriptEngine.loadDashboards",
                params: []
            };

            const DATA5 = {
                id: 5,
                method: "ScriptEngine.loadScriptInfo",
                params: []
            };

            const DATA6 = {
                id: 6,
                method: "ScriptEngine.loadScene",
                params: ["d0cf3a77-e9dd-4419-bec0-b54ecad3e541"]
            };

            const DATA7 = {
                id: 7,
                method: "ScriptEngine.registerActiveObjects",
                params: [
                    "",
                    [
                        8641, 8684, 8685, 8687, 8690, 8691,
                        8693, 8696, 8697, 8699, 8769, 8770,
                        8772, 8775, 8776, 8778, 8781, 8782,
                        8784, 8793, 8794, 8796, 8805, 8806,
                        8808, 8815, 8816, 8818, 17954, 17955,
                        18041, 18043, 18044, 18046, 18049,
                        18051, 18069, 18070, 73901, 73910, 74281, -1
                    ]
                ]
            };

         
       
     


          //ws.send(JSON.stringify(DATA) + "\n"); // ส่ง data คือ Id 0
            //  sendData(DATA);
            //  ws.onmessage = handleWSMessage;
            // // sendData(data1);
            // ws.onmessage = handleWSMessage1;


    async function setUpSession() {
       try {
         
             console.log("ส่งข้อมูลชุด ID 0 ");         
             const result = await sendData(DATA); // ลองเปลี่ยนเป็น false เพื่อดู Error
             console.log("ดึงข้อมูลสำเร็จ:", result.data);

             const result1 = await new Promise((resolve, reject) => {
                 ws.onmessage = (event) => {
                     handleWSMessage(event)
                         .then(resolve)
                         .catch(reject);
                 };
             });

/////////////////////////////////////////////////////////////////////////////////////////////////
             console.log("ส่งข้อมูลชุด ID 1 ");   
             console.log(window.USID);        
             DATA1.params[0] = window.USID;
             
             const result2 = await sendData(DATA1); // ลองเปลี่ยนเป็น false เพื่อดู Error
             console.log("ดึงข้อมูลสำเร็จ:", result2.data);


             let arguments = 1 ;
             const result3 = await new Promise((resolve, reject) => {
                 ws.onmessage = (event) => {
                     handleWSMessage1(event,arguments)
                         .then(resolve)
                         .catch(reject);
                 };
             });


/////////////////////////////////////////////////////////////////////////////////////////////
             console.log("ส่งข้อมูลชุด ID 2 ");   
             console.log(window.USID);        
             DATA2.params[0] = window.USID;
             
             const result4 = await sendData(DATA2); // ลองเปลี่ยนเป็น false เพื่อดู Error
             console.log("ดึงข้อมูลสำเร็จ:", result4.data);


            let arguments2 = 2 ;
                 const result5 = await new Promise((resolve, reject) => {
                 ws.onmessage = (event) => {
                     handleWSMessage1(event,arguments2)
                         .then(resolve)
                         .catch(reject);
                 };
             });
////////////////////////////////////////////////////////////////////////////////////////////////////
             console.log("ส่งข้อมูลชุด ID 3 ");   
                  
             const result6 = await sendData(DATA3); // ลองเปลี่ยนเป็น false เพื่อดู Error
             console.log("ดึงข้อมูลสำเร็จ:", result6.data);


            let arguments3 = 3 ;
                 const result7 = await new Promise((resolve, reject) => {
                 ws.onmessage = (event) => {
                     handleWSMessage2(event,arguments3)
                         .then(resolve)
                         .catch(reject);
                 };
             });
//////////////////////////////////////////////////////////////////////////////////////////////////////
             console.log("ส่งข้อมูลชุด ID 4 ");   
                  
             const result8 = await sendData(DATA4); // ลองเปลี่ยนเป็น false เพื่อดู Error
             console.log("ดึงข้อมูลสำเร็จ:", result8.data);


            let arguments4 = 4 ;
                 const result9 = await new Promise((resolve, reject) => {
                 ws.onmessage = (event) => {
                     handleWSMessage2(event,arguments4)
                         .then(resolve)
                         .catch(reject);
                 };
             });

//////////////////////////////////////////////////////////////////////////////////////////////////////
             console.log("ส่งข้อมูลชุด ID 5 ");   
                  
             const result10 = await sendData(DATA5); // ลองเปลี่ยนเป็น false เพื่อดู Error
             console.log("ดึงข้อมูลสำเร็จ:", result10.data);


            let arguments5 = 5 ;
                 const result11 = await new Promise((resolve, reject) => {
                 ws.onmessage = (event) => {
                     handleWSMessage2(event,arguments5)
                         .then(resolve)
                         .catch(reject);
                 };
             });

///////////////////////////////////////////////////////////////////////////////////////////////////
             console.log("ส่งข้อมูลชุด ID 6 ");   
                  
             const result12 = await sendData(DATA6); // ลองเปลี่ยนเป็น false เพื่อดู Error
             console.log("ดึงข้อมูลสำเร็จ:", result12.data);


            let arguments6 = 6 ;
                 const result13 = await new Promise((resolve, reject) => {
                 ws.onmessage = (event) => {
                     handleWSMessage2(event,arguments6)
                         .then(resolve)
                         .catch(reject);
                 };
             });

 /////////////////////////////////////////////////////////////////////////////////////////////////////
            console.log("ส่งข้อมูลชุด ID 7");
            console.log(window.USID);        
            DATA7.params[0] = window.USID;   
                  
             const result14= await sendData(DATA7); // ลองเปลี่ยนเป็น false เพื่อดู Error
             console.log("ดึงข้อมูลสำเร็จ:", result14.data);


            let arguments7 = 7 ;
                 const result15 = await new Promise((resolve, reject) => {
                 ws.onmessage = (event) => {
                     handleWSMessage1(event,arguments7)
                         .then(resolve)
                         .catch(reject);
                 };
             });
           
 ///////////////////////////////////////////////////////////////////////////////////////////////////////////

    const resultALL = await new Promise((resolve, reject) => {
        console.log("Station :", Station);
                 ws.onmessage = (event) => {
                     handleWSMessageALL(event,Station)
                         .then(resolve)
                         .catch(reject);
                 };
             });


 ////////////////////////////////////////////////////////////////////////////





        } catch (error) {
            console.error("เกิดข้อผิดพลาด:", error.message); // จะถูกจับที่นี่

        } finally {
            console.log("กระบวนการสิ้นสุดลงแล้ว")
        }
  }



       function handleWSMessageALL(event,Station) {

       
        return new Promise((resolve, reject) => {

            const msg = JSON.parse(event.data);
            if (msg.notification && msg.notification.provider === "ScriptEngine") {
                // ตัวอย่างการเข้าถึงค่า sync
                const syncData = msg.notification.value?.sync;
                if (syncData) {
                    // แสดงค่าทั้งหมดใน sync
                //     Object.entries(syncData).forEach(([key, value]) => {
                //         messagesDiv.innerHTML += `<p>sync[${key}] = ${value}</p>`;
                //     });
                // }
                // ดึงค่าเฉพาะ id ที่ต้องการและแสดงผลใน div ตาม id
                // แสดงผลเฉพาะ id ที่ต้องการใน div ตาม id
                const ids = [
                    8684, //    {"id": 8684,"name": "Active Power 1", "className": "JSAIN5Model","min": 0,"max": 25000,"thresholds": [20000, 15000, 10000, 5000],"unit": "W"},
                    8685, //    {"id": 8685,"name": "Active Power 2", "className": "JSAIN5Model","min": 0,"max": 25000,"thresholds": [20000, 15000, 10000, 5000],"unit": "W"},
                    8686, //    {"id": 8686,"name": "Active Power 3", "className": "JSAIN5Model","min": 0,"max": 25000,"thresholds": [20000, 15000, 10000, 5000],"unit": "W"},
                    8687, //    {"id": 8687,"name": "Active Power 4", "className": "JSAIN5Model","min": 0,"max": 25000,"thresholds": [20000, 15000, 10000, 5000],"unit": "W"},
                    8688, //    {"id": 8688,"name": "Active Power 5", "className": "JSAIN5Model","min": 0,"max": 25000,"thresholds": [20000, 15000, 10000, 5000],"unit": "W"},
                    8689, //    {"id": 8689,"name": "Active Power 6", "className": "JSAIN5Model","min": 0,"max": 25000,"thresholds": [20000, 15000, 10000, 5000],"unit": "W"},
                    18069, //    {"id": 18069,"name": "MUX#1 TV5 Power Meter totally","className": "JSAIN5Model","min": 0,"max": 100000000,"thresholds": [80000000, 50000000, 30000000, 10000000],"unit": "kWh" },
                    18070, //    {"id": 18070,"name": "MUX#2 MCOT Power Meter totally","className": "JSAIN5Model","min": 0,"max": 100000000,"thresholds": [80000000, 50000000, 30000000, 10000000],"unit": "kWh" },
                    73909, //    {"id": 73909,"name": "MUX#3 PRD Power Meter","className": "JSAIN5Model","min": 0,"max": 100000000,"thresholds": [80000000, 50000000, 30000000, 10000000],"unit": "kWh" },
                    73910, //    {"id": 73910,"name": "MUX#4 TPBS Power Meter","className": "JSAIN5Model","min": 0,"max": 100000000,"thresholds": [80000000, 50000000, 30000000, 10000000],"unit": "kWh" },
                ]; 
                // เพิ่มตัวแปรเพื่อระบุว่าเป็นของแพร่ (ip=0) หรือ น่าน (ip=1)
                // สมมติว่า ip ถูกกำหนดไว้ใน scope นี้ หรือส่งเข้ามาในฟังก์ชัน
                // หากไม่มี ให้เพิ่มตัวแปร window.currentIP ตอน connectWS เช่น window.currentIP = UserAgent_IP;
              const ID_Station = Station; // 0 สำหรับแพร่, 1 สำหรับน่าน

                // แสดงผลใน div ตาม id
                // ใช้ syncData[id.toString()] เพื่อเข้าถึงค่าของแต่ละ id
                // และแสดงผลใน div ที่มี id ตรงกับค่าของ id นั้น ๆ;

                ids.forEach(id => {
                    if (syncData.hasOwnProperty(id.toString())) {
                        let el = null;
                        if (ID_Station === 0) {
                            el = document.getElementById(`phrae-${id}`);
                        } else if (ID_Station === 1) {
                            el = document.getElementById(`nan-${id}`);
                        }
                        if (el) {
                            el.textContent = syncData[id.toString()];
                        }
                    }
                });
                } else {
                    console.warn("sync data not found in notification");
                }

                // console.log(msg);
                resolve({ data: " notification successfully" });
            }
            else{
                console.error('Invalid notification', e);
                reject(new Error("Invalid  notification"));
            }                  
                    
     });
    }
        
  
  setUpSession()


}           

//////////////////////////////////////////88888888888///////////////////////////////////////////////


//////////////////////////////////////****************************////////////////////////////////


     function handleWSMessage(event) {
        return new Promise((resolve, reject) => {

            const msg = JSON.parse(event.data);
            if (msg.id === 0 && msg.result && msg.result.USID) {
                window.USID = msg.result.USID;
                // messagesDiv.innerHTML += `<p>Received: ${event.data}</p>`;
                // messagesDiv.innerHTML += `<p>USID: ${window.USID}</p>`;                

                console.log(window.USID);
                resolve({ data: "Data USID successfully" });
            }
            else{
                console.error('Invalid USID :', e);
                reject(new Error("Invalid USID"));
            }                  
                    
     });
    }


     function handleWSMessage1(event,arguments) {
        return new Promise((resolve, reject) => {

            const msg = JSON.parse(event.data);
            if (msg.id === arguments && msg.result === true) {
    
                // messagesDiv.innerHTML += `<p>Received: ${event.data}</p>`;
              

                console.log(msg);
                resolve({ data: " result true successfully" });
            }
            else{
                console.error('Invalid ID , result fault:', e);
                reject(new Error("Invalid  ID result fault"));
            }                  
                    
     });
    }

    
     function handleWSMessage2(event,arguments) {
        return new Promise((resolve, reject) => {

            const msg = JSON.parse(event.data);
            if (msg.id === arguments && msg.cached === true) {
    
                // messagesDiv.innerHTML += `<p>Received: ${event.data}</p>`;
              

                console.log(msg);
                resolve({ data: " cached true successfully" });
            }
            else{
                console.error('Invalid ID , result fault:', e);
                reject(new Error("Invalid  ID result fault"));
            }                  
                    
     });
    }


       


    function sendData(data_agent) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(data_agent) + "\n"); // ส่ง data คือ Id 1
                    resolve({ data: "Data sent successfully" });
                    console.log("Data sent successfully:", data_agent);
                } else {
                    reject(new Error("WebSocket is not open"));
                    console.error("WebSocket is not open");
                }
            }, 1000);
        });
    }


           ///////////////////////////////////////////////////////////////////////// 
            



            ws.onerror = function(error) {
                document.getElementById('Error:').innerText = `Error: ${error.message}`;
            };
            ws.onclose = function() {

                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            };
        }

        function disconnectWS() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
        }

        

        connectBtn.onclick = function() {
            // ตัวอย่าง: ส่ง 0 สำหรับแพร่ หรือ 1 สำหรับน่าน
            let currentStation = 0;
            let intervalId = null;

            async function switchStations() {
                connectWS(currentStation);
                await new Promise(resolve => setTimeout(resolve,   30 * 1000)); // 30วินาที    , 5 นาที //
             //   disconnectWS();
              //  await new Promise(resolve => setTimeout(resolve, 1000)); // รอ 1 วินาทีหลัง disconnect
             //   currentStation = currentStation === 0 ? 1 : 0;
              //  switchStations();
            }

            switchStations();
                      };

        disconnectBtn.onclick = disconnectWS;
    </script>
    
</body>
</html>